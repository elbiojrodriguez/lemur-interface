<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Lemur — Visitante</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #localVideo {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 160px;
      height: 120px;
      border: 2px solid white;
      z-index: 10;
    }

    #statusMessage {
      position: absolute;
      bottom: 40px;
      width: 100%;
      text-align: center;
      font-size: 18px;
      color: white;
      z-index: 5;
    }
  </style>
</head>
<body>

  <video id="localVideo" autoplay muted playsinline></video>
  <div id="statusMessage">Esperando resposta do dono...</div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io('https://lemur-signal.onrender.com');
    const urlParams = new URLSearchParams(window.location.search);
    const targetId = urlParams.get('id');

    let localStream;
    let peer;

    async function startCall() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;

        peer = new RTCPeerConnection();

        localStream.getTracks().forEach(track => {
          peer.addTrack(track, localStream);
        });

        peer.onicecandidate = event => {
          if (event.candidate) {
            socket.emit('ice-candidate', {
              to: targetId,
              candidate: event.candidate
            });
          }
        };

        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);

        socket.emit('call', {
          to: targetId,
          from: 'visitor',
          offer: offer
        });

        console.log('Chamada enviada para', targetId);
      } catch (err) {
        alert('Permita acesso à câmera e microfone para continuar.');
        console.error(err);
      }
    }

    socket.on('acceptAnswer', async answer => {
      await peer.setRemoteDescription(new RTCSessionDescription(answer));
      console.log('Resposta recebida do dono');
      document.getElementById('statusMessage').textContent = 'Conectado com o dono!';
    });

    socket.on('ice-candidate', async candidate => {
      try {
        await peer.addIceCandidate(new RTCIceCandidate(candidate));
      } catch (err) {
        console.error('Erro ao adicionar ICE candidate', err);
      }
    });

    // Inicia tudo automaticamente
    if (targetId) {
      socket.emit('register', 'visitor');
      startCall();
    } else {
      document.getElementById('statusMessage').textContent = 'ID inválido na URL.';
    }
  </script>
</body>
</html>
