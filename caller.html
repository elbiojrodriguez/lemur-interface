<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visitante (Caller)</title>
  <style>
    body {
      background: #111;
      color: white;
      text-align: center;
      font-family: sans-serif;
    }
    video {
      width: 80%;
      border: 2px solid #ffa500;
      border-radius: 8px;
      margin-top: 20px;
    }
    #myCameraPreview {
      width: 30%;
      border: 2px solid #444;
      border-radius: 6px;
      margin-top: 10px;
    }
    input, button {
      padding: 10px;
      margin-top: 15px;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      background-color: #ffa500;
      color: black;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ðŸ“¤ Visitante inicia chamada</h1>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="myCameraPreview" autoplay muted playsinline></video>
  <p>Seu ID: <span id="myId"></span></p>
  <input type="text" id="targetId" placeholder="ID do dono">
  <button onclick="abrirMinhaCamera()">Mostrar minha cÃ¢mera</button>
  <button id="chamarBtn">Chamar</button>

  <script src="https://lemur-signal.onrender.com/socket.io/socket.io.js"></script>
  <script>
    const socket = io('https://lemur-signal.onrender.com');
    const myId = crypto.randomUUID();
    document.getElementById('myId').textContent = myId;
    socket.emit('register', myId);

    const localVideo = document.getElementById('localVideo');
    const previewVideo = document.getElementById('myCameraPreview');
    const chamarBtn = document.getElementById('chamarBtn');
    const targetInput = document.getElementById('targetId');

    let peer;

    function abrirMinhaCamera() {
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          previewVideo.srcObject = stream;
        })
        .catch(err => {
          console.error('ðŸš« Erro ao abrir cÃ¢mera local:', err);
        });
    }

    chamarBtn.onclick = () => {
      const targetId = targetInput.value.trim();
      if (!targetId) {
        alert('âš ï¸ Cole o ID do dono para iniciar a chamada');
        return;
      }

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          localVideo.srcObject = stream;

          peer = new RTCPeerConnection({
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              {
                urls: 'turn:openrelay.metered.ca:80',
                username: 'openrelayproject',
                credential: 'openrelayproject'
              }
            ]
          });

          stream.getTracks().forEach(track => peer.addTrack(track, stream));

          peer.onicecandidate = event => {
            if (event.candidate) {
              console.log('ðŸ“¨ Enviando ICE para receptor');
              socket.emit('ice-candidate', {
                to: targetId,
                candidate: event.candidate
              });
            }
          };

          peer.createOffer()
            .then(offer => peer.setLocalDescription(offer))
            .then(() => {
              console.log('ðŸ“¡ Enviando offer para receptor');
              socket.emit('call', {
                to: targetId,
                offer: peer.localDescription
              });
            })
            .catch(err => {
              console.error('ðŸš« Erro ao criar offer:', err);
            });
        })
        .catch(err => {
          console.error('ðŸš« Erro ao acessar cÃ¢mera e microfone:', err);
        });
    };

    socket.on('acceptAnswer', data => {
      if (!peer) return;
      console.log('âœ… Resposta recebida do dono');
      peer.setRemoteDescription(new RTCSessionDescription(data.answer));
    });

    socket.on('ice-candidate', candidate => {
      if (!peer) return;
      console.log('ðŸ“¨ ICE recebido do receptor');
      peer.addIceCandidate(new RTCIceCandidate(candidate));
    });
  </script>
</body>
</html>
